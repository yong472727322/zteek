<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zteek.mapper.TaskMapper" >

    <resultMap id="BaseResultMap" type="com.zteek.entity.AmazonTask" >
        <id column="id" property="id"/>
        <result column="args" property="args" />
        <result column="level" property="level" />
        <result column="site" property="site" />
        <result column="run_num" property="runNum" />
        <result column="runing_num" property="runingNum" />
        <result column="run_completed" property="runCompleted" />
        <result column="remaining" property="remaining" />
        <result column="created_by" property="createdBy" />
        <result column="created_date" property="createdDate" />

    </resultMap>

    <select id="getTask" resultMap="BaseResultMap">
         select id,args from amazon_task t where t.remaining &gt; 0 order by t.level desc limit 1
    </select>

    <update id="updateTaskById">
        update amazon_task set runing_num = runing_num + 1,remaining = remaining -1 where id = #{id}
    </update>
    <update id="completedTaskById">
        update amazon_task set runing_num = runing_num - 1,run_completed = run_completed + 1 where id = #{taskId}
    </update>


    <insert id="insertTaskRecord"  useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        insert into amazon_task_run
          (task_id,imei,result_message,result_code,created_time)
        values
          (#{taskId},#{imei},"正在执行中",0,now())
    </insert>

    <update id="updateTaskRecord">
        update amazon_task_run set result_message=#{resultMessage},result_code=#{resultCode},end_time=now(),consuming=TIMESTAMPDIFF(SECOND,created_time,now()) where id=#{id}
    </update>


</mapper>